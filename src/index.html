<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>è¯å“æ•°æ®å¯¹æ¯”å·¥å…· - ç¦»çº¿ç‰ˆ</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
    :root {
        --primary: #3498db;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --dark: #343a40;
        --gray: #6c757d;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #3498db, #2c3e50);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 800px;
        margin: 0 auto;
    }

    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    @media (max-width: 768px) {
        .container {
            grid-template-columns: 1fr;
        }
    }

    .upload-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
    }

    .upload-section:hover {
        transform: translateY(-5px);
    }

    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        color: var(--dark);
        font-size: 1.4rem;
    }

    .section-title i {
        margin-right: 10px;
        font-size: 1.8rem;
    }

    .drop-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        margin-bottom: 20px;
    }

    .drop-area:hover, .drop-area.active {
        border-color: var(--primary);
        background-color: rgba(52, 152, 219, 0.05);
    }

    .drop-area i {
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 15px;
        display: block;
    }

    .file-info {
        margin-top: 15px;
        font-size: 0.9rem;
        color: var(--gray);
    }

    .btn {
        display: inline-block;
        padding: 12px 25px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
        margin: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-success {
        background-color: var(--success);
    }

    .btn-success:hover {
        background-color: #27ae60;
    }

    .btn-danger {
        background-color: var(--danger);
    }

    .btn-danger:hover {
        background-color: #c0392b;
    }

    .btn-warning {
        background-color: var(--warning);
    }

    .btn-warning:hover {
        background-color: #e67e22;
    }

    .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 30px 0;
        flex-wrap: wrap;
    }

    .result-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .tab {
        padding: 12px 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        color: var(--gray);
    }

    .tab.active {
        color: var(--primary);
    }

    .tab.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    th {
        background-color: #f1f8ff;
        font-weight: 600;
    }

    tr:hover {
        background-color: #f8f9fa;
    }

    .status-cell {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-missing {
        background-color: rgba(231, 76, 60, 0.15);
        color: var(--danger);
    }

    .status-spec {
        background-color: rgba(243, 156, 18, 0.15);
        color: var(--warning);
    }

    .status-origin {
        background-color: rgba(41, 128, 185, 0.15);
        color: #2980b9;
    }

    .summary {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        margin: 20px 0;
        gap: 15px;
    }

    .summary-item {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        min-width: 180px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .summary-item.missing {
        background-color: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.2);
    }

    .summary-item.spec {
        background-color: rgba(243, 156, 18, 0.1);
        border: 1px solid rgba(243, 156, 18, 0.2);
    }

    .summary-item.origin {
        background-color: rgba(41, 128, 185, 0.1);
        border: 1px solid rgba(41, 128, 185, 0.2);
    }

    .summary-item h3 {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: var(--dark);
    }

    .summary-item .count {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0;
    }

    .summary-item.missing .count {
        color: var(--danger);
    }

    .summary-item.spec .count {
        color: var(--warning);
    }

    .summary-item.origin .count {
        color: var(--primary);
    }

    footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        color: var(--gray);
        font-size: 0.9rem;
        border-top: 1px solid #eee;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ddd;
    }

    .empty-state p {
        font-size: 1.2rem;
    }

    .progress-container {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--primary);
        width: 0%;
        transition: width 0.4s ease;
    }

    .storage-info {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
    }

    /* æ–°å¢æ ·å¼ç”¨äºæ˜¾ç¤ºæ¸…æ´—åçš„è§„æ ¼ */
    .clean-spec {
        font-size: 0.85em;
        color: #666;
        margin-top: 3px;
    }
</style>
</head>
<body>
<header>
<h1>è¯å“æ•°æ®å¯¹æ¯”å·¥å…·</h1>
<p class="subtitle">ä¸Šä¼ ä¸¤å¼ è¯å“è¡¨æ ¼ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œä¸‰çº§å¯¹æ¯”ï¼šè¯å“åç§°åŒ¹é… â†’ è§„æ ¼åŒ¹é… â†’ äº§åœ°åŒ¹é…ï¼Œå¹¶ç”Ÿæˆå·®å¼‚æŠ¥å‘Š</p>
</header>
<div class="container">
<div class="upload-section">
<div class="section-title">
<i>ğŸ“‹</i>
<h2>è¡¨A - æ–°æ•°æ®è¡¨</h2>
</div>
<div class="drop-area" id="dropAreaA">
<i>ğŸ“¤</i>
<p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
<p class="file-info">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</p>
<div class="file-info" id="fileInfoA">æœªé€‰æ‹©æ–‡ä»¶</div>
</div>
<input accept=".xlsx,.xls,.csv" hidden="" id="fileInputA" type="file"/>
</div>
<div class="upload-section">
<div class="section-title">
<i>ğŸ“Š</i>
<h2>è¡¨B - æ€»æ•°æ®è¡¨</h2>
</div>
<div class="drop-area" id="dropAreaB">
<i>ğŸ“¥</i>
<p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
<p class="file-info">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</p>
<div class="file-info" id="fileInfoB">æœªé€‰æ‹©æ–‡ä»¶</div>
</div>
<input accept=".xlsx,.xls,.csv" hidden="" id="fileInputB" type="file"/>
</div>
</div>
<div class="actions">
<button class="btn" disabled="" id="compareBtn">å¼€å§‹å¯¹æ¯”</button>
<button class="btn btn-danger" id="resetBtn">é‡ç½®æ•°æ®</button>
</div>
<div class="progress-container">
<div class="progress-bar" id="progressBar"></div>
</div>
<div class="result-container">
<div class="section-title">
<i>ğŸ”</i>
<h2>å¯¹æ¯”ç»“æœ</h2>
</div>
<div class="summary" id="summaryContainer">
<div class="summary-item missing">
<h3>è¯å“ç¼ºå¤±</h3>
<div class="count" id="missingCount">0</div>
<p>æ€»æ•°æ®è¡¨ä¸­ä¸å­˜åœ¨çš„è¯å“</p>
</div>
<div class="summary-item spec">
<h3>è§„æ ¼ä¸åŒ¹é…</h3>
<div class="count" id="specCount">0</div>
<p>è¯å“å­˜åœ¨ä½†è§„æ ¼ä¸åŒ</p>
</div>
<div class="summary-item origin">
<h3>äº§åœ°ä¸åŒ¹é…</h3>
<div class="count" id="originCount">0</div>
<p>è§„æ ¼ç›¸åŒä½†äº§åœ°ä¸åŒ</p>
</div>
</div>
<div class="tabs">
<div class="tab active" data-tab="missing">ç¼ºå¤±è¯å“ (<span id="missingTabCount">0</span>)</div>
<div class="tab" data-tab="spec">è§„æ ¼ä¸åŒ¹é… (<span id="specTabCount">0</span>)</div>
<div class="tab" data-tab="origin">äº§åœ°ä¸åŒ¹é… (<span id="originTabCount">0</span>)</div>
<div class="tab" data-tab="all">å…¨éƒ¨å·®å¼‚ (<span id="allTabCount">0</span>)</div>
</div>
<div class="tab-content active" id="missingContent">
<table>
<thead>
<tr>
<th>è¯å“åç§°</th>
<th>è§„æ ¼</th>
<th>äº§åœ°</th>
<th>çŠ¶æ€</th>
</tr>
</thead>
<tbody id="missingTable">
<tr>
<td class="empty-state" colspan="4">
<div>æš‚æ— ç¼ºå¤±è¯å“æ•°æ®</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="tab-content" id="specContent">
<table>
<thead>
<tr>
<th>è¯å“åç§°</th>
<th>æ–°æ•°æ®è¡¨è§„æ ¼</th>
<th>æ€»æ•°æ®è¡¨è§„æ ¼</th>
<th>äº§åœ°</th>
<th>çŠ¶æ€</th>
</tr>
</thead>
<tbody id="specTable">
<tr>
<td class="empty-state" colspan="5">
<div>æš‚æ— è§„æ ¼ä¸åŒ¹é…æ•°æ®</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="tab-content" id="originContent">
<table>
<thead>
<tr>
<th>è¯å“åç§°</th>
<th>è§„æ ¼</th>
<th>æ–°æ•°æ®è¡¨äº§åœ°</th>
<th>æ€»æ•°æ®è¡¨äº§åœ°</th>
<th>çŠ¶æ€</th>
</tr>
</thead>
<tbody id="originTable">
<tr>
<td class="empty-state" colspan="5">
<div>æš‚æ— äº§åœ°ä¸åŒ¹é…æ•°æ®</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="tab-content" id="allContent">
<table>
<thead>
<tr>
<th>è¯å“åç§°</th>
<th>è§„æ ¼</th>
<th>äº§åœ°</th>
<th>å·®å¼‚ç±»å‹</th>
<th>çŠ¶æ€</th>
</tr>
</thead>
<tbody id="allTable">
<tr>
<td class="empty-state" colspan="5">
<div>æš‚æ— å·®å¼‚æ•°æ®</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="actions">
<button class="btn btn-success" disabled="" id="downloadBtn">ä¸‹è½½ç»“æœè¡¨æ ¼</button>
<button class="btn btn-warning" disabled="" id="saveBtn">ä¿å­˜ç»“æœåˆ°ç¼“å­˜</button>
<button class="btn btn-danger" id="clearBtn">æ¸…é™¤ç¼“å­˜</button>
</div>
<div class="storage-info">
<div>ç¼“å­˜ä½¿ç”¨æƒ…å†µï¼š<span id="storageStatus">æœªä½¿ç”¨</span></div>
<div>ç¦»çº¿æ•°æ®çŠ¶æ€ï¼š<span id="dataStatus">æ— æ•°æ®</span></div>
</div>
<footer>
<p>è¯å“æ•°æ®å¯¹æ¯”å·¥å…· - ç¦»çº¿ç‰ˆæœ¬ | æ— éœ€ç™»å½• | æ•°æ®ä»…åœ¨æµè§ˆå™¨ä¸­å¤„ç†</p>
<p>æ³¨æ„ï¼šå…³é—­æµè§ˆå™¨åæœ¬åœ°ç¼“å­˜çš„æ•°æ®ä»ç„¶å¯ç”¨ï¼Œç›´åˆ°æ¸…é™¤ç¼“å­˜</p>
</footer>
<script>
    // å…¨å±€å˜é‡
    let tableA = [];
    let tableB = [];
    let results = {
        missing: [],
        spec: [],
        origin: []
    };

    // DOMå…ƒç´ 
    const dropAreaA = document.getElementById('dropAreaA');
    const dropAreaB = document.getElementById('dropAreaB');
    const fileInputA = document.getElementById('fileInputA');
    const fileInputB = document.getElementById('fileInputB');
    const fileInfoA = document.getElementById('fileInfoA');
    const fileInfoB = document.getElementById('fileInfoB');
    const compareBtn = document.getElementById('compareBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progressBar = document.getElementById('progressBar');
    const downloadBtn = document.getElementById('downloadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const storageStatus = document.getElementById('storageStatus');
    const dataStatus = document.getElementById('dataStatus');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®
        checkStoredData();

        // è®¾ç½®æ‹–æ”¾äº‹ä»¶
        setupDragAndDrop(dropAreaA, fileInputA, fileInfoA, 'A');
        setupDragAndDrop(dropAreaB, fileInputB, fileInfoB, 'B');

        // æŒ‰é’®äº‹ä»¶
        compareBtn.addEventListener('click', compareTables);
        resetBtn.addEventListener('click', resetApp);
        downloadBtn.addEventListener('click', downloadResults);
        saveBtn.addEventListener('click', saveToStorage);
        clearBtn.addEventListener('click', clearStorage);

        // æ ‡ç­¾é¡µåˆ‡æ¢
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}Content`).classList.add('active');
            });
        });
    });

    // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
    function setupDragAndDrop(dropArea, fileInput, fileInfo, tableId) {
        // ç‚¹å‡»äº‹ä»¶
        dropArea.addEventListener('click', () => fileInput.click());

        // æ‹–æ”¾äº‹ä»¶
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        dropArea.addEventListener('drop', handleDrop, false);

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', handleFileSelect);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropArea.classList.add('active');
        }

        function unhighlight() {
            dropArea.classList.remove('active');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length) {
                fileInput.files = files;
                handleFileSelect.call(fileInput, {target: fileInput});
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            fileInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
            readFile(file, tableId);
        }
    }
    // æ¸…æ´—æ•°æ®ï¼ˆè¿‡æ»¤ç©ºè¡Œ + æ¸…æ´—è§„æ ¼ï¼‰
    function cleanData(data) {
        return data
            .filter(row => {
                const name = row['è¯å“åç§°'];
                const spec = row['è§„æ ¼'];
                const origin = row['äº§åœ°'];

                // è¿‡æ»¤æ‰ä»»ä¸€å­—æ®µä¸ºç©ºçš„æ•°æ®
                return name && spec && origin &&
                       typeof name === 'string' && name.trim() !== '' &&
                       typeof spec === 'string' && spec.trim() !== '' &&
                       typeof origin === 'string' && origin.trim() !== '';
            })
            .map(row => ({
                ...row,
                'è§„æ ¼': cleanSpec(row['è§„æ ¼']),
            }));
    }


    // è¯»å–æ–‡ä»¶
function readFile(file, tableId) {
    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});

            // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // è½¬æ¢ä¸ºJSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            // æ•°æ®æ¸…æ´—ï¼ˆåŒ…æ‹¬ç©ºå€¼è¿‡æ»¤ + è§„æ ¼æ¸…æ´—ï¼‰
            const cleanedData = cleanData(jsonData);

            // æ£€æŸ¥å¿…è¦åˆ—
            const requiredCols = ['è¯å“åç§°', 'è§„æ ¼', 'äº§åœ°'];
            const firstRow = cleanedData[0] || {};
            const missingCols = requiredCols.filter(col => !(col in firstRow));

            if (missingCols.length > 0) {
                alert(`è¡¨${tableId} ç¼ºå°‘å¿…è¦åˆ—åï¼š${missingCols.join(', ')}`);
                console.error(`è¡¨${tableId} ç¼ºå°‘å¿…è¦åˆ—åï¼š${missingCols.join(', ')}`);
                return;
            }

            if (cleanedData.length === 0) {
                alert(`è¡¨${tableId} æ•°æ®ä¸ºç©ºæˆ–æ‰€æœ‰è¡Œå‡ä¸ºæ— æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹`);
                return;
            }

            if (tableId === 'A') {
                tableA = cleanedData;
            } else {
                tableB = cleanedData;
            }

            console.log(`è¡¨${tableId} æ–‡ä»¶å†…å®¹ï¼ˆå·²æ¸…æ´—ï¼‰ï¼š`, cleanedData);
            console.log(`è¡¨${tableId} åŠ è½½æˆåŠŸï¼Œå…± ${cleanedData.length} æ¡æœ‰æ•ˆè®°å½•`);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState();
        } catch (error) {
            console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
            alert('æ–‡ä»¶å¤„ç†é”™è¯¯ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
        }
    };

    reader.readAsArrayBuffer(file);
}


    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateButtonState() {
        compareBtn.disabled = !(tableA.length > 0 && tableB.length > 0);
    }

    // æ¸…æ´—è§„æ ¼
    function cleanSpec(spec) {
        if (!spec || typeof spec !== 'string') return '';
        const cleaned = spec.replace(/\s*1kg\s*/gi, '').trim();
        return cleaned;
    }

    // æ¸…æ´—äº§åœ°
    function normalizeOrigin(origin) {
        if (!origin || typeof origin !== 'string') return '';
        return origin.replace(/[çœå¸‚å¿]/g, '').trim().toLowerCase();
    }

    // æ¨¡ç³ŠåŒ¹é…äº§åœ°
    function isSimilarOrigin(originA, originB) {
        if (!originA || !originB) return false;
        const normA = normalizeOrigin(originA);
        const normB = normalizeOrigin(originB);
        return normA && normB && (normA.includes(normB) || normB.includes(normA));
    }

    // å¯¹æ¯”è¡¨æ ¼
    function compareTables() {
        // é‡ç½®ç»“æœ
        results = {
            missing: [],
            spec: [],
            origin: []
        };

        // æ˜¾ç¤ºè¿›åº¦æ¡
        progressBar.style.width = '0%';

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${progress}%`;
            if (progress >= 100) {
                clearInterval(interval);
                performComparison();
            }
        }, 50);
    }

    // æ‰§è¡Œå¯¹æ¯”é€»è¾‘
    function performComparison() {
        console.log('å¼€å§‹æ¯”å¯¹...');
        console.log('æ–°æ•°æ®è¡¨æ ·æœ¬ï¼ˆå·²æ¸…æ´—ï¼‰ï¼š', tableA.slice(0, 3));
        console.log('æ€»æ•°æ®è¡¨æ ·æœ¬ï¼ˆå·²æ¸…æ´—ï¼‰ï¼š', tableB.slice(0, 3));

        // ç¬¬ä¸€çº§å¯¹æ¯”ï¼šè¯å“åç§°ç¼ºå¤±
        results.missing = tableA.filter(itemA => {
            return !tableB.some(itemB => itemB['è¯å“åç§°'] === itemA['è¯å“åç§°']);
        });

        // ç¬¬äºŒçº§å¯¹æ¯”ï¼šè¯å“å­˜åœ¨ä½†è§„æ ¼ä¸åŒï¼ˆå·²æ¸…æ´—ï¼‰
        results.spec = tableA.filter(itemA => {
            const matchInB = tableB.find(itemB => itemB['è¯å“åç§°'] === itemA['è¯å“åç§°']);
            if (!matchInB) return false;
            return matchInB && matchInB['è§„æ ¼'] !== itemA['è§„æ ¼'];
        });

        // ç¬¬ä¸‰çº§å¯¹æ¯”ï¼šè§„æ ¼ç›¸åŒä½†äº§åœ°ä¸åŒï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
        results.origin = tableA.filter(itemA => {
            const matchInB = tableB.find(itemB =>
                itemB['è¯å“åç§°'] === itemA['è¯å“åç§°'] &&
                itemB['è§„æ ¼'] === itemA['è§„æ ¼']
            );

            if (!matchInB) return false;

            return !isSimilarOrigin(matchInB['äº§åœ°'], itemA['äº§åœ°']);
        });

        console.log(`ç¼ºå¤±è¯å“æ•°: ${results.missing.length}`);
        console.log(`è§„æ ¼ä¸åŒ¹é…æ•°: ${results.spec.length}`);
        console.log(`äº§åœ°ä¸åŒ¹é…æ•°: ${results.origin.length}`);

        // æ›´æ–°UI
        updateResultsUI();

        // å¯ç”¨æŒ‰é’®
        downloadBtn.disabled = false;
        saveBtn.disabled = false;
    }


    // æ›´æ–°ç»“æœUI
    function updateResultsUI() {
        // æ›´æ–°è®¡æ•°
        document.getElementById('missingCount').textContent = results.missing.length;
        document.getElementById('specCount').textContent = results.spec.length;
        document.getElementById('originCount').textContent = results.origin.length;

        document.getElementById('missingTabCount').textContent = results.missing.length;
        document.getElementById('specTabCount').textContent = results.spec.length;
        document.getElementById('originTabCount').textContent = results.origin.length;
        document.getElementById('allTabCount').textContent =
            results.missing.length + results.spec.length + results.origin.length;

        // æ›´æ–°è¡¨æ ¼
        updateTable('missingTable', results.missing, 'missing', 'è¯å“ç¼ºå¤±');
        updateTable('specTable', results.spec, 'spec', 'è§„æ ¼ä¸åŒ¹é…');
        updateTable('originTable', results.origin, 'origin', 'äº§åœ°ä¸åŒ¹é…');
        updateAllTable();
    }

    // æ›´æ–°å•ä¸ªè¡¨æ ¼
    function updateTable(tableId, data, type, statusText) {
        const tableBody = document.getElementById(tableId);

        if (data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${type === 'missing' ? 4 : 5}" class="empty-state">
                        <div>æš‚æ— ${statusText}æ•°æ®</div>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';

        data.forEach(item => {
            let statusClass = '';
            let statusLabel = '';

            if (type === 'missing') {
                statusClass = 'status-missing';
                statusLabel = 'è¯å“ç¼ºå¤±';
            } else if (type === 'spec') {
                statusClass = 'status-spec';
                statusLabel = 'è§„æ ¼ä¸åŒ¹é…';
            } else if (type === 'origin') {
                statusClass = 'status-origin';
                statusLabel = 'äº§åœ°ä¸åŒ¹é…';
            }

            if (type === 'spec') {
                const matchInB = tableB.find(b => b['è¯å“åç§°'] === item['è¯å“åç§°']);
                const cleanedSpecB = matchInB ? cleanSpec(matchInB['è§„æ ¼']) : 'N/A';
                const cleanedSpecA = cleanSpec(item['è§„æ ¼']);

                html += `
                    <tr>
                        <td>${item['è¯å“åç§°'] || 'N/A'}</td>
                        <td>
                            ${cleanedSpecA}
                        </td>
                        <td>
                           ${cleanedSpecB}
                        </td>
                        <td>${item['äº§åœ°'] || 'N/A'}</td>
                        <td><span class="status-cell ${statusClass}">${statusLabel}</span></td>
                    </tr>
                `;
            } else if (type === 'origin') {
                const cleanedSpecA = cleanSpec(item['è§„æ ¼']);
                const matchInB = tableB.find(b =>
                    b['è¯å“åç§°'] === item['è¯å“åç§°'] &&
                    cleanSpec(b['è§„æ ¼']) === cleanedSpecA
                );

                html += `
                    <tr>
                        <td>${item['è¯å“åç§°'] || 'N/A'}</td>
                        <td>${cleanedSpecA}</td>
                        <td>${item['äº§åœ°'] || 'N/A'}</td>
                        <td>${matchInB ? matchInB['äº§åœ°'] || 'N/A' : 'N/A'}</td>
                        <td><span class="status-cell ${statusClass}">${statusLabel}</span></td>
                    </tr>
                `;
            } else if (type === 'missing') {
                const cleanedSpecA = cleanSpec(item['è§„æ ¼']);
                html += `
                    <tr>
                        <td>${item['è¯å“åç§°'] || 'N/A'}</td>
                        <td>${cleanedSpecA}</td>
                        <td>${item['äº§åœ°'] || 'N/A'}</td>
                        <td><span class="status-cell ${statusClass}">${statusLabel}</span></td>
                    </tr>
                `;
            }
        });

        tableBody.innerHTML = html;
    }

    // æ›´æ–°å…¨éƒ¨å·®å¼‚è¡¨æ ¼
    function updateAllTable() {
        const allData = [
            ...results.missing.map(item => ({...item, type: 'missing', typeText: 'è¯å“ç¼ºå¤±'})),
            ...results.spec.map(item => ({...item, type: 'spec', typeText: 'è§„æ ¼ä¸åŒ¹é…'})),
            ...results.origin.map(item => ({...item, type: 'origin', typeText: 'äº§åœ°ä¸åŒ¹é…'}))
        ];

        const tableBody = document.getElementById('allTable');

        if (allData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <div>æš‚æ— å·®å¼‚æ•°æ®</div>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        allData.forEach(item => {
            let statusClass = '';
            const cleanedSpecA = cleanSpec(item['è§„æ ¼']);
            if (item.type === 'missing') {
                statusClass = 'status-missing';
            } else if (item.type === 'spec') {
                statusClass = 'status-spec';
            } else if (item.type === 'origin') {
                statusClass = 'status-origin';
            }

            html += `
                <tr>
                    <td>${item['è¯å“åç§°'] || 'N/A'}</td>
                    <td>${cleanedSpecA}</td>
                    <td>${item['äº§åœ°'] || 'N/A'}</td>
                    <td>${item.typeText}</td>
                    <td><span class="status-cell ${statusClass}">${item.typeText}</span></td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
    }

    // ä¸‹è½½ç»“æœ
    // ä¸‹è½½ç»“æœ - ä¿®æ”¹åçš„å‡½æ•°
    function downloadResults() {
        // åˆ›å»ºåŒ…å«æ‰€æœ‰å·®å¼‚çš„å·¥ä½œç°¿
        const wb = XLSX.utils.book_new();

        // åˆ›å»ºåŒ…å«æ‰€æœ‰å·®å¼‚çš„æ•°ç»„
        const allResults = [
            ...results.missing.map(item => ({...item})),
            ...results.spec.map(item => {
                const matchInB = tableB.find(b => b['è¯å“åç§°'] === item['è¯å“åç§°']);
                return {
                    ...item
                };
            }),
            ...results.origin.map(item => {
                const cleanedSpec = cleanSpec(item['è§„æ ¼']);
                const matchInB = tableB.find(b =>
                    b['è¯å“åç§°'] === item['è¯å“åç§°'] &&
                    cleanSpec(b['è§„æ ¼']) === cleanedSpec
                );
                return {
                    ...item
                };
            })
        ];

        // æ·»åŠ è¡¨å¤´æ˜ å°„
        const headerMap = {
            'è¯å“åç§°': 'è¯å“åç§°',
            'è§„æ ¼': 'è§„æ ¼',
            'äº§åœ°': 'äº§åœ°',
        };

        // è½¬æ¢æ•°æ®ä¸ºå·¥ä½œè¡¨æ ¼å¼
        const wsData = allResults.map(item => {
            const newItem = {};
            // ä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µ
            Object.keys(item).forEach(key => {
                const displayKey = headerMap[key] || key;
                newItem[displayKey] = item[key];
            });
            return newItem;
        });

        // æ·»åŠ å·¥ä½œè¡¨
        if (wsData.length > 0) {
            const ws = XLSX.utils.json_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "å…¨éƒ¨å·®å¼‚");
        }

        // ä¸‹è½½æ–‡ä»¶
        XLSX.writeFile(wb, "è¯å“å¯¹æ¯”ç»“æœ.xlsx");
    }
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    function saveToStorage() {
        const dataToSave = {
            tableA: tableA,
            tableB: tableB,
            results: results,
            timestamp: new Date().toISOString()
        };

        try {
            localStorage.setItem('drugComparisonData', JSON.stringify(dataToSave));
            alert('å¯¹æ¯”ç»“æœå·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼');
            checkStoredData();
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜æ•°æ®');
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }
    }

    // æ£€æŸ¥å­˜å‚¨æ•°æ®
    function checkStoredData() {
        const storedData = localStorage.getItem('drugComparisonData');

        if (storedData) {
            try {
                const data = JSON.parse(storedData);
                const date = new Date(data.timestamp);
                dataStatus.textContent = `å·²ä¿å­˜ (${date.toLocaleDateString()})`;
                storageStatus.textContent = `å·²ä½¿ç”¨ ${formatFileSize(JSON.stringify(data).length)}`;
            } catch (e) {
                dataStatus.textContent = "æ•°æ®æŸå";
                storageStatus.textContent = "æœªçŸ¥";
            }
        } else {
            dataStatus.textContent = "æ— æ•°æ®";
            storageStatus.textContent = "æœªä½¿ç”¨";
        }
    }

    // æ¸…é™¤å­˜å‚¨
    function clearStorage() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            localStorage.removeItem('drugComparisonData');
            alert('ç¼“å­˜æ•°æ®å·²æ¸…é™¤ï¼');
            checkStoredData();
        }
    }

    // é‡ç½®åº”ç”¨
    function resetApp() {
        if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿå½“å‰æœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚')) {
            tableA = [];
            tableB = [];
            results = {
                missing: [],
                spec: [],
                origin: []
            };

            fileInfoA.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            fileInfoB.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            fileInputA.value = '';
            fileInputB.value = '';

            compareBtn.disabled = true;
            downloadBtn.disabled = true;
            saveBtn.disabled = true;

            document.getElementById('missingCount').textContent = '0';
            document.getElementById('specCount').textContent = '0';
            document.getElementById('originCount').textContent = '0';

            document.getElementById('missingTabCount').textContent = '0';
            document.getElementById('specTabCount').textContent = '0';
            document.getElementById('originTabCount').textContent = '0';
            document.getElementById('allTabCount').textContent = '0';

            updateTable('missingTable', [], 'missing', 'è¯å“ç¼ºå¤±');
            updateTable('specTable', [], 'spec', 'è§„æ ¼ä¸åŒ¹é…');
            updateTable('originTable', [], 'origin', 'äº§åœ°ä¸åŒ¹é…');
            updateAllTable();

            progressBar.style.width = '0%';
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
</body>
</html>